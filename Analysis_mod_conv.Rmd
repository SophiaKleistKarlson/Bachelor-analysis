---
title: "Mod conventionality"
author: "Sophia Kleist Karlson"
date: "20 nov 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Mod 2: conventionality


```{r}

setwd("~/Social Transmission Study/Analysis of drawings/")
pacman::p_load(tidyverse, brms, ggplot2, stringr, dplyr)

RStudio.Version()

data_conv <- read_csv("data/csv_files/all_data_w_all_conv_source.csv") #we use all_data_w_all_conv_source.csv
data_conv$X1 <- NULL#removing the first unnecessary column

```

Preparing the data and checking stuff
```{r}
# Checking classes

# Generation, complexity, conventionality and confidence should be numeric
class(data_conv$Generation)
class(data_conv$Confidence)
class(data_conv$Conventionality)

# Subject and Drawing ID should be character
class(data_conv$Subject)
class(data_conv$Drawing_ID)

# Chain, condition and Source_image should be factors
class(data_conv$Chain)
class(data_conv$Condition)
class(data_conv$Source_image)

data_conv$Chain <- as.factor(data_conv$Chain)
data_conv$Condition <- as.factor(data_conv$Condition)
data_conv$Source_image <- as.factor(data_conv$Source_image)


# Chose the variables needed for the model
df_conventionality <- data_conv %>% select(Subject, Chain, Generation, Condition, Source_image, Conventionality)

```



```{r}

gen_0_cond_1 <- df_conventionality %>% subset(Generation == 0 & Condition == 1)
mean(gen_0_cond_1$Conventionality)
sd(gen_0_cond_1$Conventionality)

gen_0_cond_2 <- df_conventionality %>% subset(Generation == 0 & Condition == 2)
mean(gen_0_cond_2$Conventionality)
sd(gen_0_cond_2$Conventionality)

gen_0_cond_3 <- df_conventionality %>% subset(Generation == 0 & Condition == 3)
mean(gen_0_cond_3$Conventionality)
sd(gen_0_cond_3$Conventionality)

gen_0_cond_4 <- df_conventionality %>% subset(Generation == 0 & Condition == 4)
mean(gen_0_cond_4$Conventionality)
sd(gen_0_cond_4$Conventionality)


gen_1_cond_1 <- df_conventionality %>% subset(Generation == 1 & Condition == 1)
mean(gen_1_cond_1$Conventionality)
sd(gen_1_cond_1$Conventionality)

gen_1_cond_2 <- df_conventionality %>% subset(Generation == 1 & Condition == 2)
mean(gen_1_cond_2$Conventionality)
sd(gen_1_cond_2$Conventionality)

gen_1_cond_3 <- df_conventionality %>% subset(Generation == 1 & Condition == 3)
mean(gen_1_cond_3$Conventionality)
sd(gen_1_cond_3$Conventionality)

gen_1_cond_4 <- df_conventionality %>% subset(Generation == 1 & Condition == 4)
mean(gen_1_cond_4$Conventionality)
sd(gen_1_cond_4$Conventionality)
```


some plots
```{r}

p_load(ggplot2, tidyr, dplyr)

class(df_conventionality$Condition)
class(df_conventionality$Generation)
class(df_conventionality$Conventionality)

df_conventionality$Condition <- as.factor(df_conventionality$Condition)


range(df_conventionality$Conventionality)
mean(df_conventionality$Conventionality)#4.38
sd(df_conventionality$Conventionality)#2.81

# conditions and conventionality
plot_simple_cond <- ggplot(df_conventionality, aes(Condition, Conventionality)) +
                             #geom_smooth(method = lm)#
  geom_jitter()#geom_bar(stat = "identity")
plot_simple_cond

# generation and conventionality
plot_simple_gen <- ggplot(df_conventionality, aes(Generation, Conventionality)) +
  geom_bar(stat = "identity")
  #geom_smooth(method = lm)
plot_simple_gen




# generation, condition and conventionality
class(df_conventionality$Condition)
class(df_conventionality$Generation)
class(df_conventionality$Conventionality)

df_conventionality$Condition <- as.factor(df_conventionality$Condition)
df_conventionality$Condition <- as.character(df_conventionality$Condition)
df_conventionality$Condition <- as.numeric(df_conventionality$Condition)

df_conventionality$Generation <- as.factor(df_conventionality$Generation)
df_conventionality$Generation <- as.character(df_conventionality$Generation)
df_conventionality$Generation <- as.numeric(df_conventionality$Generation)





# make dataset for plots where sd for complexity and convenionality for each condition in each generation is made into a seperate row
sd(all_data_w_all_conv_source$Conventionality)


SD <- all_data_w_all_conv_source %>% group_by(Generation) %>% group_by(Condition) %>% mutate(SD_compl = sd(Complexity), SD_conv = sd(Conventionality)) %>% select(Chain, Generation, Condition, Complexity, Conventionality, SD_compl, SD_conv)




plot_simple_gen_cond <- ggplot(SD, aes(Generation, Conventionality, fill = Condition)) +
  geom_bar(fun.y = "mean", stat = "summary", position = "dodge") +
  ggtitle("Evolution of conventionality") +
  stat_summary(geom = "errorbar", fun.data = mean_se, position = "dodge")

plot_simple_gen_cond


plot_simple_gen_cond_chain <- ggplot(df_conventionality, aes(Generation, Conventionality, fill = Condition)) +
  geom_bar(fun.y = "mean", stat = "summary", position = "dodge") +
  ggtitle("Evolution of conventionality") +
  stat_summary(geom = "errorbar", fun.data = mean_se, position = "dodge") +
  facet_wrap(df_conventionality$Chain)

plot_simple_gen_cond_chain




plot_simple_compl <- ggplot(SD, aes(Generation, Complexity, fill = Condition)) +
  geom_bar(fun.y = "mean", stat = "summary", position = "dodge") +
  ggtitle("Evolution of complexity") +
  stat_summary(geom = "errorbar", fun.data = mean_se, position = "dodge")

plot_simple_compl



plot_simple_compl_chain <- ggplot(all_data_w_all_conv_source, aes(Generation, Complexity, fill = Condition)) +
  geom_bar(fun.y = "mean", stat = "summary", position = "dodge") +
  ggtitle("Evolution of complexity") +
  stat_summary(geom = "errorbar", fun.data = mean_se, position = "dodge") +
  facet_wrap(all_data_w_all_conv_source$Chain)

plot_simple_compl_chain



# Error bars represent standard error of the mean
ggplot(df_conventionality, aes(x=Generation, y=Conventionality, fill=Condition)) + 
    geom_bar(position=position_dodge(), stat="identity") +
    geom_errorbar(aes(ymin=Conventionality-se, ymax=Conventionality+se),
                  width=.2,                    # Width of the error bars
                  position=position_dodge(.9))

df_conventionality$Generation <- as.factor(df_conventionality$Generation)


plot_simple_gen_cond1 <- ggplot(subset(df_conventionality, Condition == 1), aes(Generation, Conventionality)) +
                             geom_col()#geom_bar(stat = "identity")
  
plot_simple_gen_cond1

plot_simple_gen_cond2 <- ggplot(subset(df_conventionality, Condition == 2), aes(Generation, Conventionality)) +
                             geom_bar(stat = "identity")
plot_simple_gen_cond2

plot_simple_gen_cond3 <- ggplot(subset(df_conventionality, Condition == 3), aes(Generation, Conventionality)) +
                             geom_bar(stat = "identity")
plot_simple_gen_cond3


plot_simple_gen_cond4 <- ggplot(subset(df_conventionality, Condition == 4), aes(Generation, Conventionality)) +
                             geom_bar(stat = "identity")
plot_simple_gen_cond4




# source image and conventionality
plot_simple_gen_source <- ggplot(df_conventionality, aes(Source_image, Conventionality)) +
  geom_bar(stat = "identity")# +
  #geom_errorbar(aes(ymin=(Complexity-sd(Complexity)), ymax=(Complexity-sd(Complexity))), width=.2, position=position_dodge(.9))
plot_simple_gen_source

# participant and conventionality
plot_simple_subj <- ggplot(df_conventionality, aes(Subject, Conventionality)) +
                            geom_jitter()#geom_bar(stat = "identity")
plot_simple_subj

```


Ideal model: 

Complexity ~ 1 + Condition*Generation +
  (1 + condition*generation | Source_image) +
  (1 + condition*generation | Subject:Chain) +
  (1 + condition*generation | Chain)


simple model, with no bayesian fansy
```{r}
pacman::p_load(lmerTest, ggplot2)

simple_mod_conv_1 <- lm(Conventionality ~ 1 + Condition, df_conventionality)
summary(simple_mod_conv_1)

simple_mod_conv_2 <- lm(Conventionality ~ 1 + Generation, df_conventionality)
summary(simple_mod_conv_2) # there is a small rise in conventionality through generations across conditions

simple_mod_conv_3 <- lm(Conventionality ~ 1 + Generation*Condition, df_conventionality)
summary(simple_mod_conv_3) # I'm a bit confused by these results


simple_mod_conv_4 <- lmerTest::lmer(Conventionality ~ 1 + Condition + (1 + Condition | Subject), df_conventionality) # failed to converge
summary(simple_mod_conv_4)

simple_mod_conv_5 <- lmerTest::lmer(Conventionality ~ 1 + Generation + (1 + Generation | Subject), df_conventionality)# boundary singular fit and failed to converge
summary(simple_mod_conv_5)


simple_mod_conv_6 <- lmerTest::lmer(Conventionality ~ 1 + Condition + Generation + 
                       (1 + Condition + Generation | Subject), df_conventionality)
summary(simple_mod_conv_6)

simple_mod_conv_7 <- lmerTest::lmer(Conventionality ~ 1 + Generation*Condition + (1 + Generation*Condition | Subject), df_conventionality)
summary(simple_mod_conv_7)
```

lmer(formula, data = NULL, REML = TRUE, control = lmerControl(),
     start = NULL, verbose = 0L, subset, weights, na.action,
     offset, contrasts = NULL, devFunOnly = FALSE)

mod_f1_2 <- lmerTest::lmer(yi ~ 1 + (1 | studyID), es_f1_2, weights = 1/vi, REML=F, control = lme4::lmerControl( check.nobs.vs.nlev ='ignore', check.nobs.vs.nRE = 'ignore'))
summary(mod_f1_2) # We get boundary (singular) fit again. Ouch. Does it matter? WHo knows. Maybe Riccardo does.





Modeling
```{r}

class(df_conventionality$Generation)

df_conventionality$Generation <- as.character(df_conventionality$Generation)
df_conventionality$Generation <- as.numeric(df_conventionality$Generation)

# Set seed so that the analysis can be re-run and give the same results
set.seed(555)


# Define the model
convention_mod <- bf(Conventionality ~ 1 + Condition + Generation + Condition:Generation + 
                       #(1 + Condition + Generation + Condition:Generation | Subject:Chain)) #+
                       (1 + Condition + Generation + Condition:Generation | Source_image))


# Figure out what priors we'll need
get_prior(convention_mod, family = gaussian, df_conventionality)

# Checking range, mean and standard deviation of complexity, to determine which family to choose and to use for beta- and intercept-priors
range(df_conventionality$Conventionality)
mean(df_conventionality$Conventionality)
sd(df_conventionality$Conventionality)

# For choosing the sd prior - GROUP BY DRAWING AND NOT SUBJECT???
df_subj <- df_conventionality %>% group_by(Subject) %>% summarize(conv_mean = mean(Conventionality)) #find mean complexity for each participant
sd(df_subj$conv_mean)#get the standard deviation of the mean complexity for each participant (0.292944). Divide this in two (0.0732)


df_source <- df_conventionality %>% group_by(Source_image) %>% summarize(conv_mean = mean(Conventionality)) #find mean 
sd(df_source$conv_mean)# 0.3502272, half of this = 0.1751136


# setting priors
prior_convention_mod <- c(
  prior(normal(4.33, 2.80),     class = b), #mean and sd of Conventionality
  prior(lkj(1),                 class = cor), # I choose lkj prior of 1 - WHY??
  prior(normal(4.33, 2.80),     class = Intercept), #mean and sd of Conventionality
  prior(normal(0, 0.18),        class = sd), #mean: 0 (I expect that they might not vary at all). sd for the mean conv for each source image = 0.35. sigma should go from 0 (the mean of the prior) to around that -> sigma: 0.18.
  prior(normal(2.80, 1.40),     class = sigma) #mean: sd of Conventionality. sigma: half of the sd of Conventionality
)


# Running the model to check priors
convention_mod0 <- brm(
  formula = convention_mod, 
  prior = prior_convention_mod,
  data = df_conventionality,
  chains = 2,
  cores = 2,
  sample_prior = "only"
)


# Prior predictive check
pp_check(convention_mod0, nsamples = 100) 


# The actual model:
convention_mod1 <- brm(
  formula = convention_mod, 
  prior = prior_convention_mod,
  data = df_conventionality,
  chains = 2,
  cores = 2,
  sample_prior = T,
  iter = 2000,
  #iter = 4000,
  control = list(adapt_delta=0.99, max_treedepth=20)
)

# Posterior predictive check
pp_check(convention_mod1, nsamples = 100)



# Model summary
summary(convention_mod1) # Warnings? Suspicious Rhat activity? Bad priors?

# Plot the model to get trace plots
plot(convention_mod1)


# Rank trace plots
mcmc_rank_overlay(complexity_mod1, 
                  pars = c("b_Intercept", "b_Condition2", "b_Condition3", "b_Condition4")) + 
  theme_classic()

mcmc_rank_overlay(complexity_mod1, 
                  pars = c("b_Generation", "b_Condition2:Generation", "b_Condition3:Generation", "b_Condition4:Generation")) + 
  theme_classic()

mcmc_rank_overlay(complexity_mod1, 
                  pars = c("sigma")) + 
  theme_classic()




hypothesis(convention_mod1,"Condition2 = Condition3") # Is condition 2 more complex than condition 3?
hypothesis(convention_mod1,"Condition3 = Condition4")
hypothesis(convention_mod1,"Condition2 = Condition4")

hypothesis(convention_mod1,"Intercept > 0")

hypothesis(convention_mod1,"Generation = 0") # this is the most probable in terms of generation
hypothesis(convention_mod1,"Condition2:Generation > 0") # this is more probable than =, and a LOT more than <
hypothesis(convention_mod1,"Condition3:Generation > 0") # this is more probable than =, and a LOT more than <
hypothesis(convention_mod1,"Condition4:Generation > 0") # this is more probable than =, and a LOT more than <

plot(hypothesis(convention_mod1, "")) # After trying different hypotheses, this turned out to be the best


# Plot conditional effects
conditional_effects(convention_mod1)
```




