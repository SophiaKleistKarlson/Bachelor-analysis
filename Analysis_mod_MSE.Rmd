---
title: "Analysis_mod_MSE"
author: "Sophia Kleist Karlson"
date: "22 nov 2020"
output: html_document
---


Mod 3: Error between images

```{r}
# set working directory
setwd("~/Social Transmission Study/Analysis of drawings/")

# load necesary packages through pacman
pacman::p_load(tidyverse, brms, ggplot2, stringr, dplyr)

# RStudio version
RStudio.Version()

# read data and delete the first unnecessary columns
data_MSE <- read_csv("data/csv_files/all_data_w_MSE.csv") #we use all_data_w_MSE.csv
data_MSE$X1 <- NULL

```


Preparing the data and checking stuff
```{r}
# Checking classes

# Generation and MSE should be numeric
class(data_MSE$Generation)
class(data_MSE$MSE)

# Subject and Drawing ID should be character
class(data_MSE$Subject)
class(data_MSE$Drawing_ID)

# Chain, condition and Source_image should be factors
class(data_MSE$Chain)
class(data_MSE$Condition)
class(data_MSE$Source_image)

data_MSE$Chain <- as.factor(data_MSE$Chain)
data_MSE$Condition <- as.factor(data_MSE$Condition)
data_MSE$Source_image <- as.factor(data_MSE$Source_image)


# Chose the variables needed for the model
df_MSE <- data_MSE %>% select(Subject, Chain, Generation, Condition, Source_image, MSE)

```


Modeling
```{r}
# Set seed so that the analysis can be re-run and give the same results
set.seed(555)

# Define the model
MSE_mod <- bf(MSE ~ 1 + Condition + mo(Generation) + Condition:mo(Generation) + 
                       (1 + Condition | gr(Subject, by = Chain)))
                       #(1 + Condition + mo(Generation) + Condition:mo(Generation) | Source_image))

df_MSE$MSE <- scale(df_MSE$MSE)
# Figure out what priors we'll need
get_prior(MSE_mod, family = gaussian, df_MSE)

# Checking range, mean and standard deviation of complexity, to determine which family to choose and to use for beta- and intercept-priors
range(df_MSE$MSE)
mean(df_MSE$MSE)
sd(df_MSE$MSE)

# For choosing the sd prior - GROUP BY DRAWING AND NOT SUBJECT???
df_part <- df_MSE %>% group_by(Subject) %>% summarize(mean_MSE = mean(MSE)) #find mean complexity for each participant
sd(df_part$mean_MSE)/2 #get the standard deviation of the mean complexity for each participant. Divide this in two


prior_MSE_mod <- c(
  prior(normal(0, 1),           class = b), #mean and sd of MSE #4.38, 2.81
  prior(normal(0, 0.25),        class = sd), #mean: 0 (I expect that they might not vary at all). sd for the mean MSE for each participant = 2780.45. sigma should go from 0 (the mean of the prior) to around that -> sigma: 1390.23.
  prior(normal(1, 0.5),         class = sigma), #mean: sd of MSE sigma: half of the sd of MSE #2.81, 1.40
  prior(lkj(1),                 class = cor), # I choose lkj prior of 1 - WHY??
  
  # simo priors for the monotonic generation variable: mean is 1 for a uniform prior, sigma is K-1, where K is the number of levels in the monotonic variable (we have 7 generations)
  prior(dirichlet(rep(1, 6)),   class = simo, coef = moGeneration:Condition21),                 
  prior(dirichlet(rep(1, 6)),   class = simo, coef = moGeneration:Condition31),             
  prior(dirichlet(rep(1, 6)),   class = simo, coef = moGeneration:Condition41),            
  prior(dirichlet(rep(1, 6)),   class = simo, coef = moGeneration1)
  
  #prior(normal(4.38, 2.81),     class = Intercept), #mean and sd of MSE
)


# Running the model to check priors
MSE_mod0 <- brm(
  formula = MSE_mod, 
  prior = prior_MSE_mod,
  data = df_MSE,
  chains = 2,
  cores = 2,
  sample_prior = "only"
)


# Prior predictive check
pp_check(MSE_mod0, nsamples = 100) # 


# The actual model:
MSE_mod1 <- brm(
  formula = MSE_mod, 
  prior = prior_MSE_mod,
  data = df_MSE,
  chains = 2,
  cores = 2,
  sample_prior = T,
  iter = 4000,
  control = list(adapt_delta=0.99, max_treedepth=20)
)

# Posterior predictive check
pp_check(MSE_mod1, nsamples = 100)



# Model summary
summary(MSE_mod1) # Warnings? Suspicious Rhat activity? Bad priors?

# Plot the model to get trace plots
plot(MSE_mod1)


# Rank trace plots
mcmc_rank_overlay(MSE_mod1, 
                  pars = c("b_Intercept", "b_Condition2", "b_Condition3", "b_Condition4")) + 
  theme_classic()

mcmc_rank_overlay(MSE_mod1, 
                  pars = c("b_Generation", "b_Condition2:Generation", "b_Condition3:Generation", "b_Condition4:Generation")) + 
  theme_classic()

mcmc_rank_overlay(MSE_mod1, 
                  pars = c("sigma")) + 
  theme_classic()




hypothesis(MSE_mod1,"Condition2 = Condition3") # Is condition 2 more complex than condition 3?
hypothesis(MSE_mod1,"Condition3 = Condition4")
hypothesis(MSE_mod1,"Condition2 = Condition4")

hypothesis(MSE_mod1,"Intercept > 0")

hypothesis(MSE_mod1,"Generation = 0") # this is the most probable in terms of generation
hypothesis(MSE_mod1,"Condition2:Generation > 0") # this is more probable than =, and a LOT more than <
hypothesis(MSE_mod1,"Condition3:Generation > 0") # this is more probable than =, and a LOT more than <
hypothesis(MSE_mod1,"Condition4:Generation > 0") # this is more probable than =, and a LOT more than <

plot(hypothesis(MSE_mod1, "")) # After trying different hypotheses, this turned out to be the best


# Plot conditional effects
conditional_effects(MSE_mod1)
```




